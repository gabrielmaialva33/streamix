"use strict";(self.webpackChunkAVPlayer=self.webpackChunkAVPlayer||[]).push([[427],{29427:(e,t,i)=>{i.r(t),i.d(t,{default:()=>c});var s=i(19371),n=i(88583),a=i(47378),o=i(25092),d=i(87339),r=i(16563),l=i(76766),u=i(39989),m=i(59435);const h="packages/avnetwork/src/ioLoader/DashIOLoader.ts";class c extends m.A{constructor(){super(...arguments),(0,s.A)(this,"info",void 0),(0,s.A)(this,"mediaPlayList",void 0),(0,s.A)(this,"fetchMediaPlayListPromise",void 0),(0,s.A)(this,"minBuffer",void 0),(0,s.A)(this,"audioResource",void 0),(0,s.A)(this,"videoResource",void 0),(0,s.A)(this,"subtitleResource",void 0),(0,s.A)(this,"aborted",void 0),(0,s.A)(this,"signal",void 0)}createResource(e){return{type:e,fetchedMap:new Map,fetchedHistoryListMax:100,fetchedHistoryList:[],loader:null,segmentIndex:0,currentUri:"",selectedIndex:0,segments:[],initSegmentPadding:"",initedSegment:"",sleep:null,lastPendingSegmentFetchTs:0,lastPendingSegmentDuration:0}}addHistory(e,t,i){e.fetchedMap.clear(),e.fetchedHistoryList.length=0;for(let s=0;s<i;s++)e.fetchedMap.set(t[s].url,!0),e.fetchedHistoryList.push(t[s].url);for(;e.fetchedHistoryList.length>=e.fetchedHistoryListMax;)e.fetchedMap.delete(e.fetchedHistoryList.shift())}async fetchMediaPlayList(e){var t,i,s;if(!e){if(this.fetchMediaPlayListPromise)return;this.fetchMediaPlayListPromise=new Promise((t=>{e=t}))}const a={method:"GET",headers:{},mode:"cors",cache:"default",referrerPolicy:"no-referrer-when-downgrade"};null!==(t=this.info.httpOptions)&&void 0!==t&&t.headers&&o.__(this.info.httpOptions.headers,((e,t)=>{a.headers[t]=e})),null!==(i=this.info.httpOptions)&&void 0!==i&&i.credentials&&(a.credentials=this.info.httpOptions.credentials),null!==(s=this.info.httpOptions)&&void 0!==s&&s.referrerPolicy&&(a.referrerPolicy=this.info.httpOptions.referrerPolicy);try{var r;"function"==typeof AbortController&&(this.signal=new AbortController);const t=await fetch(this.info.url,{...a,signal:null===(r=this.signal)||void 0===r?void 0:r.signal});this.signal=null;const i=await t.text();this.mediaPlayList=(0,l.A)(i,this.info.url),this.minBuffer=this.mediaPlayList.minBufferTime,"vod"===this.mediaPlayList.type?this.options.isLive=!1:this.options.isLive=!0;const s=(e,t,i)=>{let s=0,n=0;for(let e=t.length-2;e>=0;e--)if(!0!==t[e].pending&&(n+=t[e].segmentDuration,n>=i)){s=e;break}e.lastPendingSegmentFetchTs=this.mediaPlayList.maxSegmentDuration,e.lastPendingSegmentDuration=this.mediaPlayList.maxSegmentDuration,e.fetchedHistoryListMax=Math.max(e.fetchedHistoryListMax,t.length+1),this.addHistory(e,t,s)};if(this.mediaPlayList.mediaList.audio.length){if(this.options.preferAudioCodec||this.options.preferAudioLang){let e=!1,t=!1,i=this.mediaPlayList.mediaList.audio.some((e=>e.codecs&&e.codecs.indexOf(this.options.preferAudioCodec)>=0));this.mediaPlayList.mediaList.audio.forEach(((s,n)=>{this.options.preferAudioCodec&&i&&s.codecs&&-1===s.codecs.indexOf(this.options.preferAudioCodec)||(e||(this.audioResource.selectedIndex=n,e=!0),s.lang&&this.options.preferAudioLang&&s.lang.indexOf(this.options.preferAudioLang)>=0&&!t&&(this.audioResource.selectedIndex=n,s.lang===this.options.preferAudioLang&&(t=!0)))}))}const e=this.mediaPlayList.mediaList.audio[this.audioResource.selectedIndex];e.file?this.audioResource.segments=[{url:e.file}]:this.options.isLive&&this.audioResource.initedSegment===e.initSegment?(this.audioResource.segments=e.mediaSegments.map((e=>({url:e.url,pending:e.pending,duration:e.segmentDuration}))),this.audioResource.lastPendingSegmentFetchTs=this.mediaPlayList.timestamp,this.audioResource.lastPendingSegmentDuration=this.mediaPlayList.maxSegmentDuration):(this.options.isLive&&s(this.audioResource,e.mediaSegments,this.minBuffer),this.audioResource.segments=[{url:e.initSegment}].concat(e.mediaSegments.map((e=>({url:e.url,pending:e.pending,duration:e.segmentDuration})))),this.audioResource.initedSegment=e.initSegment)}if(this.mediaPlayList.mediaList.video.length){if(this.options.preferResolution||this.options.preferVideoCodec){let e=1,t=1;if(this.options.preferResolution){const i=this.options.preferResolution.split("*");e=+i[0]||1,t=+i[1]||1}let i=!1,s=1/0,n=this.mediaPlayList.mediaList.video.some((e=>e.codecs&&e.codecs.indexOf(this.options.preferVideoCodec)>=0));this.mediaPlayList.mediaList.video.forEach(((a,o)=>{if(!(this.options.preferVideoCodec&&n&&a.codecs&&-1===a.codecs.indexOf(this.options.preferVideoCodec))&&(i||(this.videoResource.selectedIndex=o,i=!0),a.width&&a.height&&this.options.preferResolution)){const i=1===e?1:a.width,n=1===t?1:a.height;Math.abs(i*n-e*t)<s&&(s=Math.abs(i*n-e*t),this.videoResource.selectedIndex=o)}}))}const e=this.mediaPlayList.mediaList.video[this.videoResource.selectedIndex];e.file?this.videoResource.segments=[{url:e.file}]:this.options.isLive&&this.videoResource.initedSegment===e.initSegment?(this.videoResource.segments=e.mediaSegments.map((e=>({url:e.url,pending:e.pending,duration:e.segmentDuration}))),this.videoResource.lastPendingSegmentFetchTs=this.mediaPlayList.maxSegmentDuration,this.videoResource.lastPendingSegmentDuration=this.mediaPlayList.maxSegmentDuration):(this.options.isLive&&s(this.videoResource,e.mediaSegments,this.minBuffer),this.videoResource.segments=[{url:e.initSegment}].concat(e.mediaSegments.map((e=>({url:e.url,pending:e.pending,duration:e.segmentDuration})))),this.videoResource.initedSegment=e.initSegment)}if(this.mediaPlayList.mediaList.subtitle.length){if(this.options.preferSubtitleCodec||this.options.preferSubtitleLang){let e=!1,t=!1,i=this.mediaPlayList.mediaList.subtitle.some((e=>e.codecs&&e.codecs.indexOf(this.options.preferSubtitleCodec)>=0));this.mediaPlayList.mediaList.subtitle.forEach(((s,n)=>{this.options.preferSubtitleCodec&&i&&s.codecs&&-1===s.codecs.indexOf(this.options.preferSubtitleCodec)||(e||(this.subtitleResource.selectedIndex=n,e=!0),s.lang&&this.options.preferSubtitleLang&&s.lang.indexOf(this.options.preferSubtitleLang)>=0&&!t&&(this.subtitleResource.selectedIndex=n,s.lang===this.options.preferSubtitleLang&&(t=!0)))}))}const e=this.mediaPlayList.mediaList.subtitle[this.subtitleResource.selectedIndex];e.file?this.subtitleResource.segments=[{url:e.file}]:this.options.isLive&&this.subtitleResource.initedSegment===e.initSegment?(this.subtitleResource.segments=e.mediaSegments.map((e=>({url:e.url,pending:e.pending,duration:e.segmentDuration}))),this.subtitleResource.lastPendingSegmentFetchTs=this.mediaPlayList.maxSegmentDuration,this.subtitleResource.lastPendingSegmentDuration=this.mediaPlayList.maxSegmentDuration):(this.options.isLive&&s(this.subtitleResource,e.mediaSegments,this.minBuffer),this.subtitleResource.segments=[{url:e.initSegment}].concat(e.mediaSegments.map((e=>({url:e.url,pending:e.pending,duration:e.segmentDuration})))),this.subtitleResource.initedSegment=e.initSegment)}return e(),this.fetchMediaPlayListPromise=null,this.status=2,this.retryCount=0,this.mediaPlayList}catch(t){if(this.aborted)return this.status=3,void e();if(this.retryCount<this.options.retryCount)return this.retryCount++,d.z3(`failed fetch mpd file ${t}, retry(${this.retryCount}/3)`,h,397),await new n.A(2===this.status?this.options.retryInterval:5),this.fetchMediaPlayList(e);this.status=3,e(),d.h2(`DashLoader: exception, fetch slice error, error: ${t.message}`,h,405)}}async open(e){return 2===this.status?0:0!==this.status?a.lh:(this.info=e,this.videoResource=this.createResource(0),this.audioResource=this.createResource(1),this.subtitleResource=this.createResource(3),this.status=1,this.retryCount=0,this.aborted=!1,await this.fetchMediaPlayList(),0)}async readResource(e,t){let i=0;if(t.loader){if(i=await t.loader.read(e),-1048576!==i||this.aborted)return i;if(this.options.isLive)t.fetchedMap.set(t.currentUri,!0),t.fetchedHistoryList.length===t.fetchedHistoryListMax&&t.fetchedMap.delete(t.fetchedHistoryList.shift()),t.fetchedHistoryList.push(t.currentUri);else if(t.segmentIndex++,t.segmentIndex>=t.segments.length)return-1048576;t.loader=null}if(this.options.isLive){const i=t.segments.filter((e=>!t.fetchedMap.get(e.url)));if(!i.length){if(this.mediaPlayList.isEnd)return-1048576;const i=(this.mediaPlayList.duration||this.mediaPlayList.minimumUpdatePeriod)-((0,r.A)()-this.mediaPlayList.timestamp)/1e3;if(i>0&&(t.sleep=new n.A(i),await t.sleep,t.sleep=null,this.aborted))return-1048576;if(this.fetchMediaPlayListPromise){if(await this.fetchMediaPlayListPromise,3===this.status||this.aborted)return-1048576}else if(await this.fetchMediaPlayList(),this.aborted)return-1048576;return this.readResource(e,t)}if(t.currentUri=i[0].url,this.options.isLive&&i[0].pending){if(t.lastPendingSegmentFetchTs){const e=t.lastPendingSegmentDuration-((0,r.A)()-t.lastPendingSegmentFetchTs)/1e3;if(e>0&&(t.sleep=new n.A(e),await t.sleep,t.sleep=null,this.aborted))return-1048576}t.lastPendingSegmentFetchTs=(0,r.A)(),t.lastPendingSegmentDuration=i[0].duration||this.mediaPlayList.maxSegmentDuration}return t.loader=new u.A(o.X$({},this.options,{disableSegment:!0,loop:!1,enableBandwidthReader:0===t.type})),await t.loader.open(o.X$({},this.info,{url:t.currentUri}),{from:0,to:-1}),t.loader.read(e)}return t.loader=new u.A(o.X$({},this.options,{disableSegment:!0,loop:!1,enableBandwidthReader:0===t.type})),t.initSegmentPadding?(await t.loader.open(o.X$({},this.info,{url:t.initSegmentPadding}),{from:0,to:-1}),t.initSegmentPadding=null,t.segmentIndex--):await t.loader.open(o.X$({},this.info,{url:t.segments[t.segmentIndex].url}),{from:0,to:-1}),t.loader.read(e)}async read(e,t){return 1===t.mediaType?this.readResource(e,this.audioResource):0===t.mediaType?this.readResource(e,this.videoResource):3===t.mediaType?this.readResource(e,this.subtitleResource):a.UY}async seekResource(e,t){let i="";t.loader&&(i=t.loader.getUrl(),await t.loader.abort(),t.loader=null);let s=Number(BigInt.asIntN(32,e));if(t.segments){let e=0;const n=1===t.type?this.mediaPlayList.mediaList.audio:0===t.type?this.mediaPlayList.mediaList.video:this.mediaPlayList.mediaList.subtitle,a=n[t.selectedIndex].mediaSegments;if(null!=a&&a.length){e=-1;for(let t=0;t<a.length;t++)if(s>=1e3*a[t].start&&s<1e3*a[t].end){e=t;break}-1===e&&(e=a.length-1)}t.segmentIndex=e+(n[t.selectedIndex].initSegment?1:0);let o="";0===t.type?o=this.mediaPlayList.mediaList.video[t.selectedIndex].initSegment:1===t.type?o=this.mediaPlayList.mediaList.audio[t.selectedIndex].initSegment:3===t.type&&(o=this.mediaPlayList.mediaList.subtitle[t.selectedIndex].initSegment),o&&o===i&&(t.initSegmentPadding=o)}}async seek(e,t){return 1===t.mediaType&&this.audioResource.loader&&await this.seekResource(e,this.audioResource),0===t.mediaType&&this.videoResource.loader&&await this.seekResource(e,this.videoResource),3===t.mediaType&&this.subtitleResource.loader&&await this.seekResource(e,this.subtitleResource),4===this.status&&(this.status=2),this.aborted=!1,0}async size(){return BigInt(0)}abortSleep(){this.aborted=!0,this.videoResource.loader&&this.videoResource.loader.abortSleep(),this.videoResource.sleep&&(this.videoResource.sleep.stop(),this.videoResource.sleep=null),this.audioResource.loader&&this.audioResource.loader.abortSleep(),this.audioResource.sleep&&(this.audioResource.sleep.stop(),this.audioResource.sleep=null),this.subtitleResource.loader&&this.subtitleResource.loader.abortSleep(),this.subtitleResource.sleep&&(this.subtitleResource.sleep.stop(),this.subtitleResource.sleep=null)}async abort(){this.abortSleep(),this.signal&&this.signal.abort(),this.videoResource.loader&&(await this.videoResource.loader.abort(),this.videoResource.loader=null),this.audioResource.loader&&(await this.audioResource.loader.abort(),this.audioResource.loader=null),this.subtitleResource.loader&&(await this.subtitleResource.loader.abort(),this.subtitleResource.loader=null)}async stop(){await this.abort(),this.status=0}getDuration(){return this.mediaPlayList.duration}hasVideo(){var e;return(null===(e=this.mediaPlayList)||void 0===e?void 0:e.mediaList.video.length)>0}hasAudio(){var e;return(null===(e=this.mediaPlayList)||void 0===e?void 0:e.mediaList.audio.length)>0}hasSubtitle(){var e;return(null===(e=this.mediaPlayList)||void 0===e?void 0:e.mediaList.subtitle.length)>0}getVideoList(){return this.hasVideo()?{list:this.mediaPlayList.mediaList.video.map((e=>({width:e.width,height:e.height,frameRate:e.frameRate,codec:e.codecs,bandwidth:e.bandwidth}))),selectedIndex:this.videoResource.selectedIndex}:{list:[],selectedIndex:0}}getAudioList(){return this.hasAudio()?{list:this.mediaPlayList.mediaList.audio.map((e=>({lang:e.lang,codec:e.codecs,bandwidth:e.bandwidth}))),selectedIndex:this.audioResource.selectedIndex}:{list:[],selectedIndex:0}}getSubtitleList(){return this.hasSubtitle()?{list:this.mediaPlayList.mediaList.subtitle.map((e=>({lang:e.lang,codec:e.codecs}))),selectedIndex:this.subtitleResource.selectedIndex}:{list:[],selectedIndex:0}}selectVideo(e){if(e!==this.videoResource.selectedIndex&&this.hasVideo()&&e>=0&&e<this.mediaPlayList.mediaList.video.length){this.videoResource.selectedIndex=e;const t=this.mediaPlayList.mediaList.video[this.videoResource.selectedIndex];if(t.file)this.videoResource.segments=[{url:t.file}];else{if(this.options.isLive){let e=this.videoResource.segmentIndex;this.videoResource.segments.find(((t,i)=>{if(t.url===this.videoResource.currentUri)return e=i,!0})),this.addHistory(this.videoResource,t.mediaSegments,e+1)}this.videoResource.segments=[{url:t.initSegment}].concat(t.mediaSegments.map((e=>({url:e.url,pending:e.pending,duration:e.segmentDuration})))),this.videoResource.initSegmentPadding=t.initSegment}if(t.mediaSegments&&this.videoResource.segmentIndex-(t.initSegment?1:0)<t.mediaSegments.length-1)return t.mediaSegments[this.videoResource.segmentIndex+(t.initSegment?0:1)].start}return-1}selectAudio(e){if(e!==this.audioResource.selectedIndex&&this.hasAudio()&&e>=0&&e<this.mediaPlayList.mediaList.audio.length){this.audioResource.selectedIndex=e;const t=this.mediaPlayList.mediaList.audio[this.audioResource.selectedIndex];if(t.file)this.audioResource.segments=[{url:t.file}];else{if(this.options.isLive){let e=this.audioResource.segmentIndex;this.audioResource.segments.find(((t,i)=>{if(t.url===this.audioResource.currentUri)return e=i,!0})),this.addHistory(this.audioResource,t.mediaSegments,e+1)}this.audioResource.segments=[{url:t.initSegment}].concat(t.mediaSegments.map((e=>({url:e.url,pending:e.pending,duration:e.segmentDuration})))),this.audioResource.initSegmentPadding=t.initSegment}if(t.mediaSegments&&this.audioResource.segmentIndex-(t.initSegment?1:0)<t.mediaSegments.length-1)return t.mediaSegments[this.audioResource.segmentIndex+(t.initSegment?0:1)].start}return-1}selectSubtitle(e){if(e!==this.subtitleResource.selectedIndex&&this.hasSubtitle()&&e>=0&&e<this.mediaPlayList.mediaList.subtitle.length){this.subtitleResource.selectedIndex=e;const t=this.mediaPlayList.mediaList.subtitle[this.subtitleResource.selectedIndex];if(t.file)this.subtitleResource.segments=[{url:t.file}];else{if(this.options.isLive){let e=this.subtitleResource.segmentIndex;this.subtitleResource.segments.find(((t,i)=>{if(t.url===this.subtitleResource.currentUri)return e=i,!0})),this.addHistory(this.subtitleResource,t.mediaSegments,e+1)}this.subtitleResource.segments=[{url:t.initSegment}].concat(t.mediaSegments.map((e=>({url:e.url,pending:e.pending,duration:e.segmentDuration})))),this.subtitleResource.initSegmentPadding=t.initSegment}if(t.mediaSegments&&this.subtitleResource.segmentIndex-(t.initSegment?1:0)<t.mediaSegments.length-1)return t.mediaSegments[this.subtitleResource.segmentIndex+(t.initSegment?0:1)].start}return-1}getCurrentProtection(e){return 1===e?this.mediaPlayList.mediaList.audio[this.audioResource.selectedIndex].protection:0===e?this.mediaPlayList.mediaList.video[this.videoResource.selectedIndex].protection:void 0}getMinBuffer(){return this.minBuffer}}},76766:(e,t,i)=>{i.d(t,{A:()=>p});var s=i(79880),n=i(73575),a=i(25092),o=i(16563),d=i(81819);function r(e){const t=e.match(/^PT?(?:(\d+)Y)?(?:(\d+)D)?(?:(\d+)H)?(?:(\d+)M)?(?:(\d+(?:\.\d+)?)S)?$/);if(!t)throw new Error("Invalid DASH PT duration: "+e);const[,i,s,n,a,o]=t;return 3600*parseInt(i||"0")*24*365+3600*parseInt(s||"0")*24+3600*parseInt(n||"0")+60*parseInt(a||"0")+parseFloat(o||"0")}function l(e,t){const i=(0,n.A)(e);return i.length>=t?i:"0".repeat(t-i.length)+i}function u(e){if(!e)return 0;if(e.indexOf("/")>-1){const t=e.split("/");return parseFloat(t[0])/parseFloat(t[1])}return parseFloat(e)}function m(e){e=e.replaceAll("-","");const t=[];for(let i=0;i<e.length;i+=2)t.push(+`0x${e.substring(i,i+2)}`);return new Uint8Array(t)}function h(e){let t={};return e.forEach((e=>{const i={};if(a.__(e,((e,t)=>{i[t.toLocaleLowerCase()]=e})),i["cenc:default_kid"]&&(t.kid=m(i["cenc:default_kid"]),t.scheme=i.value),i.schemeiduri){const e=i.schemeiduri.split(":");3===e.length&&"urn"===e[0]&&"uuid"===e[1]&&(t.systemId=m(e[2]))}i["clearkey:laurl"]&&(t.url=i["clearkey:laurl"].value),i["dashif:laurl"]&&(t.url=i["dashif:laurl"].value)})),t}function c(e,t){return/^https?:\/\//.test(t)?t:e+t}function g(e,t,i){const s={mediaList:{audio:[],video:[],subtitle:[]},type:"live",isEnd:!1,duration:0,minBufferTime:0,maxSegmentDuration:0,minimumUpdatePeriod:0,timeShiftBufferDepth:0,timestamp:(0,o.A)()},a=[];"static"===e.type&&(s.type="vod",s.isEnd=!0),e.minBufferTime&&(s.minBufferTime=r(e.minBufferTime)),e.maxSegmentDuration&&(s.maxSegmentDuration=r(e.maxSegmentDuration)),e.minimumUpdatePeriod&&(s.minimumUpdatePeriod=Math.min(r(e.minimumUpdatePeriod),30*Math.max(s.maxSegmentDuration,2))),e.availabilityStartTime&&(s.availabilityStartTime=new Date(e.availabilityStartTime).getTime()),e.timeShiftBufferDepth&&(s.timeShiftBufferDepth=r(e.timeShiftBufferDepth)),e.mediaPresentationDuration&&(s.duration=r(e.mediaPresentationDuration));let m="";return e.BaseURL&&(m=d.YO(e.BaseURL)?e.BaseURL[0].value:d.Yj(e.BaseURL)?e.BaseURL:e.BaseURL.value),null!=t&&t.duration&&(s.duration=r(t.duration)),t.BaseURL&&(m=c(m,d.Yj(t.BaseURL)?t.BaseURL:t.BaseURL.value)),(d.YO(t.AdaptationSet)?t.AdaptationSet:[t.AdaptationSet]).forEach(((e,t)=>{let r,g="",p="",f="",S=0,L=0,R=0,b=0,y=0,v="1:1",P="1",x=0,I=m,w="und";e.BaseURL&&(I=c(I,d.Yj(e.BaseURL)?e.BaseURL:e.BaseURL.value)),e.lang&&(w=e.lang),e.mimeType||e.contentType?(g=e.mimeType,p=e.contentType,"video/mp4"===g||"video"===p?(f=e.codecs,S=parseFloat(e.width),L=parseFloat(e.height),e.maxWidth&&(R=parseFloat(e.maxWidth)),e.maxHeight&&(b=parseFloat(e.maxHeight)),e.frameRate&&(y=u(e.frameRate)),v=e.sar,P=e.startWithSAP,x=parseFloat(e.bandwidth)):"audio/mp4"!==g&&"audio"!==p||(f=e.codecs,P=e.startWithSAP,x=parseFloat(e.bandwidth))):(e.maxWidth&&(R=parseFloat(e.maxWidth)),e.maxHeight&&(b=parseFloat(e.maxHeight)),e.frameRate&&(y=u(e.frameRate))),e.ContentProtection&&(r=h(e.ContentProtection)),(d.YO(e.Representation)?e.Representation:[e.Representation]).forEach(((t,u)=>{a.indexOf(t.id)>-1&&(t.id=(parseInt(a[a.length-1])+1).toString()),a.push(t.id);let m="";const A=[];let T=0,D=s.duration,B=c(i.slice(0,i.lastIndexOf("/")+1),I);if(t.mimeType&&(g=t.mimeType),"video/mp4"===g||"video"===p?(t.codecs&&(f=t.codecs),t.width&&(S=parseFloat(t.width)),t.height&&(L=parseFloat(t.height)),t.maxWidth&&(R=parseFloat(t.maxWidth)),t.maxHeight&&(b=parseFloat(t.maxHeight)),t.frameRate&&(y=parseFloat(t.frameRate)),t.sar&&(v=t.sar),t.startWithSAP&&(P=t.startWithSAP),t.bandwidth&&(x=parseFloat(t.bandwidth))):(t.codecs&&(f=t.codecs),t.startWithSAP&&(P=t.startWithSAP),t.bandwidth&&(x=parseFloat(t.bandwidth))),t.BaseURL&&(B=c(B,d.Yj(t.BaseURL)?t.BaseURL:t.BaseURL.value)),t.ContentProtection&&(r=h(t.ContentProtection)),t.SegmentBase)"video/mp4"===g||"video"===p?s.mediaList.video.push({id:t.id,file:B,mimeType:g,codecs:f,width:S,height:L,maxWidth:R,maxHeight:b,frameRate:y,sar:v,startWithSAP:"1"===P,bandwidth:x,timescale:T,duration:D,protection:r}):"audio/mp4"===g||"audio"===p?s.mediaList.audio.push({id:t.id,file:B,mimeType:g,codecs:f,startWithSAP:"1"===P,bandwidth:x,timescale:T,duration:D,protection:r,lang:w}):"application/mp4"!==g&&"text"!==p||s.mediaList.subtitle.push({id:t.id,file:B,mimeType:g,codecs:f,startWithSAP:"1"===P,bandwidth:x,timescale:T,duration:D,protection:r,lang:w});else{let i;if(e.SegmentTemplate&&(i=d.YO(e.SegmentTemplate)?e.SegmentTemplate[0]:e.SegmentTemplate),t.SegmentTemplate&&(i=d.YO(t.SegmentTemplate)?t.SegmentTemplate[0]:t.SegmentTemplate),i){let e=i.startNumber?parseInt(i.startNumber):1;if(m=i.initialization,T=parseFloat(i.timescale||"1"),i.duration&&!i.SegmentTimeline){D=parseFloat(i.duration);let a=D/T,r=e+Math.ceil((s.duration||a)/a)-1,u=r;if("live"===s.type&&(d.ai(s.availabilityStartTime)||i.presentationTimeOffset)){const t=((s.timestamp||(0,o.A)())-s.availabilityStartTime)/1e3-(i.presentationTimeOffset?parseInt(i.presentationTimeOffset):0);r=e+Math.floor(t/a),s.timeShiftBufferDepth&&(e=r-Math.ceil(s.timeShiftBufferDepth/a)+1),u=r,("false"===i.availabilityTimeComplete||s.minimumUpdatePeriod>2*s.minBufferTime)&&(r+=Math.ceil(s.minimumUpdatePeriod/a))}for(let o=e;o<=r;o++){const d=a*(o-e);let m=a*(o-e+1);o===r&&s.duration&&(a=s.duration-a*(r-e),m=s.duration),A.push({idx:o,start:d,end:m,url:B+i.media.replace(/\$RepresentationID\$/g,t.id).replace(/\$Number(%(\d+)d)?\$/g,((e,t,i)=>i?l(o,+i):(0,n.A)(o))),segmentDuration:a,pending:o>u})}}else if(i.SegmentTimeline&&i.SegmentTimeline.S){const s=d.YO(i.SegmentTimeline.S)?i.SegmentTimeline.S:[i.SegmentTimeline.S];let a=0,o=e;for(let e=0;e<s.length;e++){let d=parseFloat(s[e].d);s[e].t&&(a=parseFloat(s[e].t));let r=1;s[e].r&&(r=parseInt(s[e].r),-1===r&&D?r=Math.ceil(D*T/d):r+=1);for(let e=0;e<r;e++)A.push({idx:o,start:a/T,end:(a+d)/T,url:B+i.media.replace(/\$RepresentationID\$/g,t.id).replace(/\$Number(%(\d+)d)?\$/g,((e,t,i)=>i?l(o,+i):(0,n.A)(o))).replace(/\$Time\$/g,(0,n.A)(a)),segmentDuration:d/T}),o++,a+=d}}}else if(t.SegmentList){const e=d.YO(t.SegmentList.SegmentURL)?t.SegmentList.SegmentURL:[t.SegmentList.SegmentURL];let i=0,s=parseFloat(t.SegmentList.duration);for(let t=0;t<e.length;t++)A.push({idx:t,start:i/T,end:(i+s)/T,url:B+e[t].media,segmentDuration:s/T}),i+=s}"video/mp4"===g||"video"===p?s.mediaList.video.push({id:t.id,baseURL:B,initSegment:B+m.replace(/\$RepresentationID\$/g,t.id).replace(/\$Bandwidth\$/g,(0,n.A)(x)),mediaSegments:A,mimeType:g,codecs:f,width:S,height:L,maxWidth:R,maxHeight:b,frameRate:y,sar:v,startWithSAP:"1"===P,bandwidth:x,timescale:T,duration:D,protection:r}):"audio/mp4"===g||"audio"===p?s.mediaList.audio.push({id:t.id,baseURL:B,initSegment:B+m.replace(/\$RepresentationID\$/g,t.id).replace(/\$Bandwidth\$/g,(0,n.A)(x)),mediaSegments:A,mimeType:g,codecs:f,startWithSAP:"1"===P,bandwidth:x,timescale:T,duration:D,protection:r,lang:w}):"application/mp4"!==g&&"text"!==p||s.mediaList.subtitle.push({id:t.id,baseURL:B,initSegment:B+m.replace(/\$RepresentationID\$/g,t.id).replace(/\$Bandwidth\$/g,(0,n.A)(x)),mediaSegments:A,mimeType:g,codecs:f,startWithSAP:"1"===P,bandwidth:x,timescale:T,duration:D,protection:r,lang:w})}}))})),["video","audio"].forEach((e=>{s.mediaList[e].sort(((e,t)=>e.bandwidth-t.bandwidth))})),s}function p(e,t){const i=(n=e,n?(0,s.A)(n,{aloneValueName:"value"}):null).MPD;var n;if("dynamic"===i.type){const e=d.YO(i.Period)?i.Period[i.Period.length-1]:i.Period;return g(i,e,t)}{const e=(d.YO(i.Period)?i.Period:[i.Period]).map((e=>g(i,e,t))),s=e[0];for(let t=1;t<e.length;t++)s.duration+=e[t].duration,e[t].mediaList.video.forEach((e=>{const t=s.mediaList.video.find((t=>e.initSegment&&e.initSegment===t.initSegment||e.id===t.id));var i,n;t?(null!==(i=t.mediaSegments)&&void 0!==i&&i.length&&null!==(n=e.mediaSegments)&&void 0!==n&&n.length&&e.mediaSegments.forEach((e=>{e.start+=t.mediaSegments[t.mediaSegments.length-1].end,e.end+=t.mediaSegments[t.mediaSegments.length-1].end})),t.mediaSegments=(t.mediaSegments||[]).concat(e.mediaSegments||[])):s.mediaList.video.push(e)})),e[t].mediaList.audio.forEach((e=>{const t=s.mediaList.audio.find((t=>e.initSegment&&e.initSegment===t.initSegment||e.id===t.id));var i,n;t?(null!==(i=t.mediaSegments)&&void 0!==i&&i.length&&null!==(n=e.mediaSegments)&&void 0!==n&&n.length&&e.mediaSegments.forEach((e=>{e.start+=t.mediaSegments[t.mediaSegments.length-1].end,e.end+=t.mediaSegments[t.mediaSegments.length-1].end})),t.mediaSegments=(t.mediaSegments||[]).concat(e.mediaSegments||[])):s.mediaList.audio.push(e)})),e[t].mediaList.subtitle.forEach((e=>{const t=s.mediaList.subtitle.find((t=>e.initSegment&&e.initSegment===t.initSegment||e.id===t.id));var i,n;t?(null!==(i=t.mediaSegments)&&void 0!==i&&i.length&&null!==(n=e.mediaSegments)&&void 0!==n&&n.length&&e.mediaSegments.forEach((e=>{e.start+=t.mediaSegments[t.mediaSegments.length-1].end,e.end+=t.mediaSegments[t.mediaSegments.length-1].end})),t.mediaSegments=(t.mediaSegments||[]).concat(e.mediaSegments||[])):s.mediaList.subtitle.push(e)}));return i.mediaPresentationDuration&&(s.duration=r(i.mediaPresentationDuration)),s}}},79880:(e,t,i)=>{i.d(t,{A:()=>o});var s=i(17630);const n={aloneValueName:"_@attribute"},a=[" ","/",'"',"'","<",">"];function o(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n;e=(e=(e=(e=e.replace(/<!--[\s\S]*?-->/g,"")).replace(/[\n\t\r]/g,"")).replace(/>[ \t]+</g,"><")).replace(/<\?[^>]*\?>/g,"");const i=[];let o=0;function d(e,s){const n=i[i.length-1];n&&(e!==t.aloneValueName||null==n.obj[t.aloneValueName]?null==n.obj[e]?n.obj[e]=s:Array.isArray(n.obj[e])?n.obj[e].push(s):n.obj[e]=[n.obj[e],s]:n.obj[t.aloneValueName]=[n.obj[t.aloneValueName],{tagName:e,...s}])}function r(t){for(;o<e.length;){if(e[o]===t)return!0;o++}return!1}function l(){u();let t="";for(;o<e.length&&!s.zy(a,e[o]);)t+=e[o],o++;return t}function u(){for(;o<e.length&&/\s|\r|\n/.test(e[o]);)o++}const m=/\s/,h=/'/,c=/"/;function g(){if(o>=e.length)return!0;u();let t=m;'"'!==e[o]&&"'"!=e[o]||(t='"'===e[o]?c:h,o++);let i="";for(;o<e.length;){if(t.test(e[o])){o++;break}i+=e[o],o++}return i}function p(){u();let t="";for(;o<e.length&&"<"!==e[o];)t+=e[o],o++;return t}function f(){for(;"<"===e[o];){const t=o;if(o++,u(),"/"!==e[o]){o=t;break}if(o++,l()===i[i.length-1].tag){if(i.length>1){const e=i.pop();d(e.tag,e.obj)}r(">"),o++,u()}else i.pop(),r(">"),o++,u()}}return function s(){if(o>=e.length)return;let n=o;if(u(),"<"!==e[o])return o=n,d(t.aloneValueName,p()),f(),s();let a=r("<");if(!a)return;n=o,o++;const m=l();if(i.push({obj:{},tag:m,start:n}),function(){for(;u(),">"!==e[o]&&"/"!==e[o];){let e=l();if(!e)break;"="===e[e.length-1]?e=e.substring(0,e.length-1):(r("="),o++),d(e,g())}}(),u(),"/"===e[o]){if(o++,i.length>1){const e=i.pop();d(e.tag,e.obj)}return r(">"),o++,f(),s()}a=r(">"),a&&(o++,u(),"<"!==e[o]&&(d(t.aloneValueName,p()),u()),f(),s())}(),{[i[0].tag]:i[0].obj}}}}]);