# Stream Proxy for Streamix IPTV via pannxs.mahina.cloud
# This proxies HTTP IPTV streams through HTTPS to avoid mixed content blocking
#
# Install on VPS at: /etc/nginx/sites-available/stream-proxy
# Then: ln -s /etc/nginx/sites-available/stream-proxy /etc/nginx/sites-enabled/
# And: nginx -t && systemctl reload nginx
#
# IMPORTANT: This config hides upstream CORS headers to prevent duplicates!
# Many IPTV servers send their own Access-Control-Allow-Origin headers.

server {
    listen 8081;
    server_name pannxs.mahina.cloud;

    proxy_buffering off;
    proxy_request_buffering off;

    resolver 8.8.8.8 8.8.4.4 valid=300s ipv6=off;
    resolver_timeout 5s;

    location = /proxy {
        # Handle OPTIONS preflight
        if ($request_method = OPTIONS) {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Range, Accept-Encoding, Content-Type, Origin, Accept' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range, Accept-Ranges' always;
            add_header 'Access-Control-Max-Age' '86400' always;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' '0';
            return 204;
        }

        set $target_url $arg_url;

        # IMPORTANT: Hide upstream CORS headers to prevent duplicates!
        # Many IPTV servers send their own CORS headers
        proxy_hide_header 'Access-Control-Allow-Origin';
        proxy_hide_header 'Access-Control-Allow-Methods';
        proxy_hide_header 'Access-Control-Allow-Headers';
        proxy_hide_header 'Access-Control-Expose-Headers';
        proxy_hide_header 'Access-Control-Max-Age';

        # Add our own CORS headers (single values only)
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Range, Accept-Encoding, Content-Type' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range, Accept-Ranges, Content-Type' always;
        add_header 'X-Accel-Buffering' 'no' always;
        add_header 'Cache-Control' 'no-cache, no-store, must-revalidate' always;
        add_header 'Accept-Ranges' 'bytes' always;

        proxy_pass $target_url;
        proxy_http_version 1.1;
        proxy_set_header Host $proxy_host;
        proxy_set_header User-Agent "VLC/3.0.20 LibVLC/3.0.20";
        proxy_set_header Accept "*/*";
        proxy_set_header Connection "";
        proxy_set_header Range $http_range;

        proxy_pass_header Content-Range;
        proxy_pass_header Accept-Ranges;

        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        proxy_intercept_errors on;
        recursive_error_pages on;
        error_page 301 302 303 307 308 = @handle_redirect;
    }

    location @handle_redirect {
        set $redirect_url $upstream_http_location;

        # Hide upstream CORS here too
        proxy_hide_header 'Access-Control-Allow-Origin';
        proxy_hide_header 'Access-Control-Allow-Methods';
        proxy_hide_header 'Access-Control-Allow-Headers';
        proxy_hide_header 'Access-Control-Expose-Headers';

        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range, Accept-Ranges' always;
        add_header 'X-Accel-Buffering' 'no' always;
        add_header 'Accept-Ranges' 'bytes' always;

        proxy_pass $redirect_url;
        proxy_http_version 1.1;
        proxy_set_header User-Agent "VLC/3.0.20 LibVLC/3.0.20";
        proxy_set_header Accept "*/*";
        proxy_set_header Range $http_range;
        proxy_buffering off;
    }

    location /health {
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Content-Type' 'application/json';
        return 200 '{"status":"ok"}';
    }
}
